---
// Astro component for displaying an interactive globe
---

<div id="globe-container"></div>

<style>
  #globe-container {
    width: 100%;
    height: 600px;
    margin: 2rem 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    background: linear-gradient(to bottom, #000428, #004e92);
    position: relative;
  }
  
  #globe-container canvas {
    display: block;
  }

  @media (max-width: 768px) {
    #globe-container {
      height: 400px;
    }
  }
</style>

<script>
  // è¶³è¿¹æ•°æ®
  const footprints = [
    { lat: 39.9042, lng: 116.4074, name: 'åŒ—äº¬', year: 2024, color: '#ff6b6b', size: 0.5 },
    { lat: 31.2304, lng: 121.4737, name: 'ä¸Šæµ·', year: 2024, color: '#4ecdc4', size: 0.5 },
    { lat: 22.3193, lng: 114.1694, name: 'é¦™æ¸¯', year: 2023, color: '#45b7d1', size: 0.5 },
    { lat: 35.6762, lng: 139.6503, name: 'ä¸œäº¬', year: 2023, color: '#96ceb4', size: 0.5 },
    { lat: 37.5665, lng: 126.9780, name: 'é¦–å°”', year: 2022, color: '#ffeaa7', size: 0.5 },
    { lat: 1.3521, lng: 103.8198, name: 'æ–°åŠ å¡', year: 2022, color: '#dfe6e9', size: 0.5 },
  ];

  // è¿æ¥çº¿æ•°æ®
  const arcs = [
    { startLat: 39.9042, startLng: 116.4074, endLat: 31.2304, endLng: 121.4737 },
    { startLat: 31.2304, startLng: 121.4737, endLat: 22.3193, endLng: 114.1694 },
    { startLat: 22.3193, startLng: 114.1694, endLat: 35.6762, endLng: 139.6503 },
  ];

  // åˆå§‹åŒ–å‡½æ•°
  function initGlobe() {
    const container = document.getElementById('globe-container');
    if (!container) {
      console.error('Globe container not found');
      return;
    }

    console.log('Starting globe initialization...');

    // åŠ¨æ€å¯¼å…¥ globe.gl
    import('globe.gl')
      .then((module) => {
        const Globe = module.default;
        console.log('Globe.gl module loaded');

        try {
          const globe = Globe()(container)
            .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
            .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
            .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
            
            // æ·»åŠ è¶³è¿¹ç‚¹
            .pointsData(footprints)
            .pointAltitude('size')
            .pointColor('color')
            .pointRadius(0.5)
            .pointLabel((d) => `
              <div style="
                background: rgba(0, 0, 0, 0.8);
                padding: 8px 12px;
                border-radius: 6px;
                color: white;
                font-family: system-ui, -apple-system, sans-serif;
              ">
                <strong>${d.name}</strong><br/>
                <span style="opacity: 0.8;">${d.year}</span>
              </div>
            `)
            
            // æ·»åŠ è¿æ¥çº¿
            .arcsData(arcs)
            .arcColor(() => 'rgba(255, 255, 255, 0.5)')
            .arcDashLength(0.4)
            .arcDashGap(0.2)
            .arcDashAnimateTime(2000)
            .arcStroke(0.5)
            
            // æ·»åŠ å…‰æ™•æ•ˆæœ
            .atmosphereColor('lightskyblue')
            .atmosphereAltitude(0.15)
            
            // æ§åˆ¶è®¾ç½®
            .enablePointerInteraction(true);

          // è‡ªåŠ¨æ—‹è½¬
          if (globe.controls) {
            globe.controls().autoRotate = true;
            globe.controls().autoRotateSpeed = 0.5;
            globe.controls().enableZoom = true;
          }

          // è®¾ç½®åˆå§‹è§†è§’ - èšç„¦åœ¨ä¸­å›½
          globe.pointOfView({ lat: 35, lng: 105, altitude: 2 }, 1000);

          // å“åº”å¼å¤„ç†
          const handleResize = () => {
            const container = document.getElementById('globe-container');
            if (container && globe) {
              globe.width(container.offsetWidth);
              globe.height(container.offsetHeight);
            }
          };
          
          window.addEventListener('resize', handleResize);
          // å»¶è¿Ÿè°ƒç”¨ä»¥ç¡®ä¿å®¹å™¨å·²æ¸²æŸ“
          setTimeout(handleResize, 100);

          // æ·»åŠ ç‚¹å‡»äº¤äº’
          globe.onPointClick((point) => {
            globe.pointOfView({
              lat: point.lat,
              lng: point.lng,
              altitude: 1.5
            }, 1000);
          });

          console.log('Globe initialized successfully');
        } catch (error) {
          console.error('Error creating globe:', error);
          container.innerHTML = `
            <div style="
              display: flex;
              align-items: center;
              justify-content: center;
              height: 100%;
              color: white;
              text-align: center;
              padding: 2rem;
            ">
              <div>
                <p style="font-size: 1.5rem; margin-bottom: 1rem;">ğŸ˜…</p>
                <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">åœ°çƒä»ªåŠ è½½å¤±è´¥</p>
                <p style="opacity: 0.7;">è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
              </div>
            </div>
          `;
        }
      })
      .catch((error) => {
        console.error('Error loading globe.gl module:', error);
        container.innerHTML = `
          <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            text-align: center;
            padding: 2rem;
          ">
            <div>
              <p style="font-size: 1.5rem; margin-bottom: 1rem;">ğŸ˜…</p>
              <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">æ— æ³•åŠ è½½åœ°çƒä»ªæ¨¡å—</p>
              <p style="opacity: 0.7;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
            </div>
          </div>
        `;
      });
  }

  // ç­‰å¾… DOM åŠ è½½å®Œæˆ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGlobe);
  } else {
    // DOM å·²åŠ è½½ï¼Œç¨ä½œå»¶è¿Ÿååˆå§‹åŒ–
    setTimeout(initGlobe, 100);
  }
</script>
